{% extends "admin/base.html" %}

{% block admin_title %}Editar Jogador{% endblock %}

{% block admin_content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-user-edit"></i> Editar Jogador: {{ jogador.nome }}
                </h5>
            </div>
            <div class="card-body">
                <!-- Preview da Foto -->
                <div class="text-center mb-4">
                    {% if jogador.foto_perfil %}
                    <img src="{{ jogador.foto_perfil }}" alt="{{ jogador.nome }}" 
                         class="img-thumbnail rounded-circle mb-2" style="width: 150px; height: 150px; object-fit: cover;">
                    <br>
                    <button type="button" class="btn btn-sm btn-danger" onclick="removerFoto({{ jogador.id }})">
                        <i class="fas fa-trash"></i> Remover Foto
                    </button>
                    {% else %}
                    <div class="mb-3">
                        <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center mx-auto" 
                             style="width: 150px; height: 150px;">
                            <i class="fas fa-user text-white fa-4x"></i>
                        </div>
                        <p class="text-muted mt-2">Nenhuma foto definida</p>
                    </div>
                    {% endif %}
                    
                    <!-- Upload de Foto -->
                    <div class="mt-3">
                        <label class="form-label">Upload de Nova Foto</label>
                        <div class="input-group">
                            <input type="file" class="form-control" id="foto_perfil" 
                                   accept="image/*" onchange="previewFoto(event)">
                            <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('foto_perfil').click()">
                                <i class="fas fa-upload"></i> Escolher
                            </button>
                        </div>
                        <div class="form-text">Formatos: JPG, PNG, GIF. Máximo: 2MB</div>
                    </div>
                </div>
                
                <form method="POST" action="{{ url_for('editar_jogador', id=jogador.id) }}" id="formEditarJogador">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="nome" class="form-label">Nome Completo *</label>
                            <input type="text" class="form-control" id="nome" name="nome" 
                                   value="{{ jogador.nome }}" required>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="apelido" class="form-label">Apelido</label>
                            <input type="text" class="form-control" id="apelido" name="apelido"
                                   value="{{ jogador.apelido or '' }}">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="telefone" class="form-label">Telefone</label>
                            <input type="tel" class="form-control" id="telefone" name="telefone" 
                                   value="{{ jogador.telefone or '' }}" placeholder="(11) 99999-9999">
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="cidade" class="form-label">Cidade</label>
                            <input type="text" class="form-control" id="cidade" name="cidade"
                                   value="{{ jogador.cidade or '' }}">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="data_nascimento" class="form-label">Data de Nascimento</label>
                            <input type="date" class="form-control" id="data_nascimento" name="data_nascimento"
                                   value="{{ jogador.data_nascimento.strftime('%Y-%m-%d') if jogador.data_nascimento else '' }}">
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="altura" class="form-label">Altura</label>
                            <input type="text" class="form-control" id="altura" name="altura"
                                   value="{{ jogador.altura or '' }}" placeholder="Ex: 1.85m">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="posicao" class="form-label">Posição Principal</label>
                            <select class="form-select" id="posicao" name="posicao">
                                <option value="">Selecione...</option>
                                <option value="levantador" {% if jogador.posicao == 'levantador' %}selected{% endif %}>Levantador</option>
                                <option value="ponteiro" {% if jogador.posicao == 'ponteiro' %}selected{% endif %}>Ponteiro</option>
                                <option value="central" {% if jogador.posicao == 'central' %}selected{% endif %}>Central</option>
                                <option value="libero" {% if jogador.posicao == 'libero' %}selected{% endif %}>Líbero</option>
                                <option value="oposto" {% if jogador.posicao == 'oposto' %}selected{% endif %}>Oposto</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="nivel" class="form-label">Nível</label>
                            <select class="form-select" id="nivel" name="nivel" required>
                                <option value="iniciante" {% if jogador.nivel == 'iniciante' %}selected{% endif %}>Iniciante</option>
                                <option value="intermediario" {% if jogador.nivel == 'intermediario' %}selected{% endif %}>Intermediário</option>
                                <option value="avancado" {% if jogador.nivel == 'avancado' %}selected{% endif %}>Avançado</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="mensalista" name="mensalista"
                                       {% if jogador.mensalista %}checked{% endif %}>
                                <label class="form-check-label" for="mensalista">
                                    <i class="fas fa-star text-warning"></i> Mensalista
                                </label>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="capitao" name="capitao"
                                       {% if jogador.capitao %}checked{% endif %}>
                                <label class="form-check-label" for="capitao">
                                    <i class="fas fa-crown text-warning"></i> Capitão
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row" id="ordemCapitaoContainer" {% if not jogador.capitao %}style="display: none;"{% endif %}>
                        <div class="col-md-6 mb-3">
                            <label for="ordem_capitao" class="form-label">Ordem do Capitão</label>
                            <select class="form-select" id="ordem_capitao" name="ordem_capitao">
                                {% for i in range(1, 7) %}
                                <option value="{{ i }}" {% if jogador.ordem_capitao == i %}selected{% endif %}>
                                    {{ i }}º - {{ i }}º a escolher
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('admin_jogadores') }}" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary" id="btnSalvar">
                            <i class="fas fa-save"></i> Salvar Alterações
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Seção de Conta do Usuário -->
        <div class="card mt-3">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0"><i class="fas fa-user-circle"></i> Conta de Usuário</h6>
            </div>
            <div class="card-body">
                {% if jogador.user %}
                    <div class="alert alert-success">
                        <h6><i class="fas fa-user-check"></i> Usuário Vinculado</h6>
                        <p class="mb-1"><strong>Usuário:</strong> {{ jogador.user.username }}</p>
                        <p class="mb-1"><strong>Tipo:</strong> {{ jogador.user.role|title }}</p>
                        <p class="mb-1"><strong>E-mail:</strong> {{ jogador.user.email or 'Não informado' }}</p>
                        <p class="mb-0"><strong>Último Login:</strong> 
                            {% if jogador.user.last_login %}
                                {{ format_date(jogador.user.last_login, '%d/%m/%Y %H:%M') }}
                            {% else %}
                                Nunca fez login
                            {% endif %}
                        </p>
                    </div>
                    
                    <div class="btn-group">
                        <button type="button" class="btn btn-warning" onclick="resetPassword({{ jogador.id }})">
                            <i class="fas fa-key"></i> Redefinir Senha Aleatória
                        </button>
                        <a href="{{ url_for('mudar_senha_jogador', id=jogador.id) }}" class="btn btn-primary">
                            <i class="fas fa-key"></i> Definir Senha Manual
                        </a>
                    </div>
                    
                    {% if jogador.capitao %}
                    <div class="alert alert-warning mt-2">
                        <small><i class="fas fa-info-circle"></i> Este jogador é capitão. Se remover o status de capitão, 
                        o usuário será mantido com role "jogador".</small>
                    </div>
                    {% endif %}
                {% else %}
                    <div class="alert alert-warning">
                        <i class="fas fa-user-times"></i> Não há usuário vinculado.
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="criar_usuario" name="criar_usuario">
                        <label class="form-check-label" for="criar_usuario">
                            <i class="fas fa-user-plus"></i> Criar conta de usuário para este jogador
                        </label>
                    </div>
                    
                    {% if jogador.capitao %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Um usuário será criado automaticamente ao salvar, 
                        pois este jogador é capitão.
                    </div>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
let fotoArquivo = null;
let fotoPreview = null;

document.addEventListener('DOMContentLoaded', function() {
    const capitaoCheckbox = document.getElementById('capitao');
    const ordemContainer = document.getElementById('ordemCapitaoContainer');
    const criarUsuarioCheckbox = document.getElementById('criar_usuario');
    const form = document.getElementById('formEditarJogador');
    
    capitaoCheckbox.addEventListener('change', function() {
        if (this.checked) {
            ordemContainer.style.display = 'block';
            if (criarUsuarioCheckbox) {
                criarUsuarioCheckbox.checked = true;
                criarUsuarioCheckbox.disabled = true;
            }
            // ADICIONE ESTA LINHA:
            alert('⚠️ Ao marcar como capitão, será criado/atualizado um usuário com role "capitao"!');
        } else {
            ordemContainer.style.display = 'none';
            if (criarUsuarioCheckbox) {
                criarUsuarioCheckbox.disabled = false;
            }
            // ADICIONE ESTA LINHA:
            alert('⚠️ Ao desmarcar como capitão, o usuário manterá acesso mas com role "jogador"!');
        }
    });
    
  
    // Se capitão já estiver marcado, mostra o container
    if (capitaoCheckbox.checked) {
        ordemContainer.style.display = 'block';
        if (criarUsuarioCheckbox) {
            criarUsuarioCheckbox.checked = true;
            criarUsuarioCheckbox.disabled = true;
        }
    }
    
    // Upload de foto
    form.addEventListener('submit', function(e) {
        if (fotoArquivo) {
            e.preventDefault();
            
            const btnSalvar = document.getElementById('btnSalvar');
            const originalText = btnSalvar.innerHTML;
            btnSalvar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
            btnSalvar.disabled = true;
            
            const formData = new FormData();
            formData.append('foto', fotoArquivo);
            
            fetch('/admin/jogador/{{ jogador.id }}/upload_foto', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Continua com o envio do formulário
                    form.removeEventListener('submit', arguments.callee);
                    form.submit();
                } else {
                    alert('Erro ao fazer upload da foto: ' + data.message);
                    btnSalvar.innerHTML = originalText;
                    btnSalvar.disabled = false;
                }
            })
            .catch(error => {
                alert('Erro ao fazer upload da foto.');
                btnSalvar.innerHTML = originalText;
                btnSalvar.disabled = false;
            });
        }
    });
});

function previewFoto(event) {
    const file = event.target.files[0];
    if (file) {
        if (file.size > 2 * 1024 * 1024) {
            alert('Arquivo muito grande! Máximo 2MB.');
            event.target.value = '';
            return;
        }
        fotoArquivo = file;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            // Atualiza a visualização da foto
            let preview = document.querySelector('.img-thumbnail');
            if (!preview) {
                preview = document.createElement('img');
                preview.className = 'img-thumbnail rounded-circle mb-2';
                preview.style = 'width: 150px; height: 150px; object-fit: cover;';
                const fotoDiv = document.querySelector('.text-center.mb-4');
                fotoDiv.insertBefore(preview, fotoDiv.firstChild);
            }
            preview.src = e.target.result;
            fotoPreview = e.target.result;
        }
        reader.readAsDataURL(file);
    }
}

function removerFoto(jogadorId) {
    if (confirm('Deseja remover a foto deste jogador?')) {
        fetch('/admin/jogador/' + jogadorId + '/upload_foto', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ remover: true })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Foto removida com sucesso!');
                location.reload();
            } else {
                alert('Erro: ' + data.message);
            }
        })
        .catch(error => {
            alert('Erro ao remover foto.');
        });
    }
}

function resetPassword(jogadorId) {
    if (confirm('Deseja redefinir a senha deste usuário para uma senha aleatória?')) {
        fetch('/admin/jogador/' + jogadorId + '/reset_password')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Nova senha gerada: ' + data.password + '\n\nAnote esta senha!');
                } else {
                    alert('Erro: ' + data.message);
                }
            })
            .catch(error => {
                alert('Erro ao redefinir senha.');
            });
    }
}
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}Completar Perfil - Sistema de Vôlei{% endblock %}

{% block extra_css %}
<style>
    .profile-complete-container {
        min-height: calc(100vh - 200px);
        padding: 2rem 0;
    }
    
    .profile-card {
        border: none;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        background: linear-gradient(145deg, #ffffff, #f8f9fa);
    }
    
    .card-header-custom {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        padding: 2rem 1.5rem;
        border-bottom: none;
        position: relative;
        overflow: hidden;
        text-align: center;
    }
    
    .card-header-custom::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%235dade2' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
    }
    
    .header-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        display: inline-block;
        padding: 1rem;
        background: rgba(255,255,255,0.2);
        border-radius: 50%;
        width: 80px;
        height: 80px;
        line-height: 60px;
    }
    
    .progress-steps {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 2rem;
        position: relative;
    }
    
    .progress-steps::before {
        content: '';
        position: absolute;
        top: 15px;
        left: 25px;
        right: 25px;
        height: 2px;
        background: #e9ecef;
        z-index: 1;
    }
    
    .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        z-index: 2;
        flex: 1;
    }
    
    .step-number {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: #e9ecef;
        color: #6c757d;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-bottom: 0.5rem;
        border: 2px solid white;
    }
    
    .step-number.active {
        background: #3498db;
        color: white;
    }
    
    .step-number.completed {
        background: #2ecc71;
        color: white;
    }
    
    .step-label {
        font-size: 0.8rem;
        color: #6c757d;
        text-align: center;
    }
    
    .step.active .step-label {
        color: #3498db;
        font-weight: 600;
    }
    
    .step.completed .step-label {
        color: #2ecc71;
    }
    
    /* Foto de perfil */
    .photo-upload-section {
        text-align: center;
        padding: 2rem;
        border: 2px dashed #dee2e6;
        border-radius: 15px;
        background: #f8f9fa;
        cursor: pointer;
        transition: all 0.3s;
        margin-bottom: 2rem;
        position: relative;
    }
    
    .photo-upload-section:hover {
        border-color: #3498db;
        background: #edf7ff;
    }
    
    .photo-upload-section.dragover {
        border-color: #2ecc71;
        background: #e8f8ef;
        transform: scale(1.02);
    }
    
    .photo-preview-container {
        width: 150px;
        height: 150px;
        margin: 0 auto 1rem;
        border-radius: 50%;
        overflow: hidden;
        border: 3px solid #3498db;
        position: relative;
    }
    
    .photo-preview {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .photo-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #e9ecef;
        color: #6c757d;
        font-size: 3rem;
    }
    
    .photo-remove-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: #e74c3c;
        color: white;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.3s;
        z-index: 5;
    }
    
    .photo-preview-container:hover .photo-remove-btn {
        opacity: 1;
    }
    
    .upload-btn {
        background: #3498db;
        color: white;
        border: none;
        padding: 0.5rem 1.5rem;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s;
        margin-bottom: 0.5rem;
    }
    
    .upload-btn:hover {
        background: #2980b9;
        transform: translateY(-2px);
    }
    
    .photo-instructions {
        font-size: 0.85rem;
        color: #6c757d;
        margin-top: 0.5rem;
    }
    
    /* Loading spinner para foto */
    .photo-loading {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255,255,255,0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 4;
        border-radius: 50%;
    }
    
    .photo-loading i {
        font-size: 2rem;
        color: #3498db;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* Formulário */
    .form-control {
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 0.75rem 1rem;
        transition: all 0.3s;
        font-size: 1rem;
    }
    
    .form-control:focus {
        border-color: #3498db;
        box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.25);
    }
    
    .input-group-text {
        background-color: #f8f9fa;
        border: 2px solid #e9ecef;
        border-right: none;
        border-radius: 10px 0 0 10px;
    }
    
    .form-control.with-icon {
        border-left: none;
        border-radius: 0 10px 10px 0;
    }
    
    .form-section {
        margin-bottom: 2.5rem;
        padding-bottom: 2rem;
        border-bottom: 1px solid #e9ecef;
    }
    
    .section-title {
        color: #3498db;
        font-weight: 600;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
    }
    
    .section-title i {
        margin-right: 0.75rem;
        font-size: 1.2rem;
    }
    
    .btn-complete-profile {
        background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        border: none;
        border-radius: 10px;
        padding: 1rem 2rem;
        font-size: 1.1rem;
        font-weight: 600;
        letter-spacing: 0.5px;
        transition: all 0.3s;
        width: 100%;
    }
    
    .btn-complete-profile:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
    }
    
    .btn-skip {
        background: transparent;
        border: 2px solid #95a5a6;
        color: #95a5a6;
        border-radius: 10px;
        padding: 1rem 2rem;
        font-size: 1rem;
        transition: all 0.3s;
        width: 100%;
    }
    
    .btn-skip:hover {
        background: #95a5a6;
        color: white;
    }
    
    .optional-badge {
        background: #f8f9fa;
        color: #6c757d;
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        margin-left: 0.5rem;
        font-weight: normal;
    }
    
    .requirements {
        font-size: 0.85rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }
    
    .info-box {
        background: #e8f4fc;
        border-left: 4px solid #3498db;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
    }
    
    @media (max-width: 768px) {
        .profile-card {
            margin: 1rem;
        }
        
        .card-header-custom {
            padding: 1.5rem 1rem;
        }
        
        .header-icon {
            font-size: 2.5rem;
            width: 70px;
            height: 70px;
            line-height: 50px;
        }
        
        .progress-steps {
            padding: 0 0.5rem;
        }
        
        .step-label {
            font-size: 0.7rem;
        }
        
        .photo-preview-container {
            width: 120px;
            height: 120px;
        }
    }
    
    /* Estilo para campos data */
    input[type="date"] {
        position: relative;
    }
    
    input[type="date"]::-webkit-calendar-picker-indicator {
        cursor: pointer;
        border-radius: 4px;
        padding: 0.25rem;
    }
    
    /* Estilo para alertas */
    .alert-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
    }
    
    /* Progresso de upload */
    .upload-progress {
        width: 100%;
        height: 4px;
        background: #e9ecef;
        border-radius: 2px;
        margin-top: 0.5rem;
        overflow: hidden;
        display: none;
    }
    
    .upload-progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #3498db, #2ecc71);
        width: 0%;
        transition: width 0.3s;
    }
    
    /* Info de compressão */
    .compression-info {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 0.75rem;
        margin-top: 1rem;
        border-left: 3px solid #17a2b8;
        font-size: 0.85rem;
    }
    
    .compression-badge {
        background: #17a2b8;
        color: white;
        font-size: 0.7rem;
        padding: 0.2rem 0.5rem;
        border-radius: 10px;
        margin-left: 0.5rem;
    }
    
    .compression-stats {
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: 0.5rem;
    }
    
    .compression-stats i {
        color: #2ecc71;
        margin-right: 0.3rem;
    }
    
    /* Debug info (opcional) */
    .debug-info {
        position: fixed;
        bottom: 10px;
        right: 10px;
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 0.5rem;
        border-radius: 5px;
        font-size: 0.7rem;
        z-index: 10000;
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="profile-complete-container">
    <div class="col-lg-10 col-xl-8 mx-auto">
        <div class="profile-card">
            <!-- Cabeçalho -->
            <div class="card-header-custom text-white">
                <div class="header-icon">
                    <i class="fas fa-user-edit"></i>
                </div>
                <h1 class="h3 mb-2">Complete seu perfil</h1>
                <p class="mb-0 opacity-75">Adicione suas informações para participar dos jogos</p>
            </div>
            
            <!-- Progresso -->
            <div class="progress-steps pt-4 px-4">
                <div class="step completed">
                    <div class="step-number completed">
                        <i class="fas fa-check"></i>
                    </div>
                    <div class="step-label">Conta criada</div>
                </div>
                <div class="step active">
                    <div class="step-number active">2</div>
                    <div class="step-label">Perfil do jogador</div>
                </div>
            </div>
            
            <div class="card-body p-4 p-md-5">
                <!-- Informações da conta -->
                <div class="info-box mb-4">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-user-circle me-3 fa-2x text-primary"></i>
                        <div>
                            <strong>Conta criada:</strong> {{ username }}
                            {% if email %}<br><small class="text-muted">{{ email }}</small>{% endif %}
                        </div>
                    </div>
                </div>
                
                <form method="POST" action="{{ url_for('completar_perfil') }}" id="profileForm" enctype="multipart/form-data">
                    <input type="file" id="foto_input" name="foto" accept="image/*" style="display: none;">
                    
                    <!-- Seção: Foto de Perfil -->
                    <div class="form-section">
                        <h5 class="section-title">
                            <i class="fas fa-camera"></i> Foto de Perfil
                            <span class="optional-badge">Opcional</span>
                        </h5>
                        
                        <div class="photo-upload-section" id="photoUploadArea">
                            <div class="photo-preview-container">
                                <div class="photo-placeholder" id="photoPlaceholder">
                                    <i class="fas fa-user"></i>
                                </div>
                                <img id="photoPreview" class="photo-preview" style="display: none;">
                                <div class="photo-loading" id="photoLoading" style="display: none;">
                                    <i class="fas fa-spinner"></i>
                                </div>
                                <button type="button" class="photo-remove-btn" id="removePhotoBtn" style="display: none;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            
                            <button type="button" class="upload-btn mb-2" id="uploadPhotoBtn">
                                <i class="fas fa-upload me-2"></i> Escolher Foto
                            </button>
                            
                            <!-- Barra de progresso -->
                            <div class="upload-progress" id="uploadProgress">
                                <div class="upload-progress-bar" id="uploadProgressBar"></div>
                            </div>
                            
                            <p class="photo-instructions mb-2">
                                Clique para escolher uma foto ou arraste uma imagem aqui<br>
                                Formatos: JPG, PNG, GIF, WebP (até 20MB, serão comprimidas para até 4MB)
                            </p>
                            
                            <!-- Info de compressão -->
                            <div class="compression-info" id="compressionInfo" style="display: none;">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-compress-alt me-2 text-info"></i>
                                    <div>
                                        <strong>Compressão automática ativada</strong>
                                        <span class="compression-badge">Otimizada</span>
                                    </div>
                                </div>
                                <div class="compression-stats" id="compressionStats">
                                    <!-- Stats serão preenchidos via JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Seção: Informações Pessoais -->
                    <div class="form-section">
                        <h5 class="section-title">
                            <i class="fas fa-id-card"></i> Informações Pessoais
                        </h5>
                        
                        <!-- Nome Completo -->
                        <div class="mb-4">
                            <label for="nome" class="form-label fw-semibold mb-2">
                                Primeiro nome (sobrenome opcional) *
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-user"></i>
                                </span>
                                <input type="text" 
                                       class="form-control with-icon" 
                                       id="nome" 
                                       name="nome" 
                                       placeholder="Primeiro nome (sobrenome opcional)"
                                       required
                                       autocomplete="name">
                            </div>
                            <div class="requirements mt-2">
                                <small>• Como você será identificado nas listas de jogadores</small>
                            </div>
                        </div>
                        
                        <!-- Apelido -->
                        <div class="mb-4">
                            <label for="apelido" class="form-label fw-semibold mb-2">
                                Apelido
                                <span class="optional-badge">Opcional</span>
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-user-tag"></i>
                                </span>
                                <input type="text" 
                                       class="form-control with-icon" 
                                       id="apelido" 
                                       name="apelido" 
                                       placeholder="Como prefere ser chamado"
                                       autocomplete="nickname">
                            </div>
                        </div>
                        
                        <!-- Linha com Data de Nascimento e Altura -->
                        <div class="row mb-4">
                            <div class="col-md-6 mb-3 mb-md-0">
                                <label for="data_nascimento" class="form-label fw-semibold mb-2">
                                    <i class="fas fa-birthday-cake me-1"></i> Data de Nascimento
                                    <span class="optional-badge">Opcional</span>
                                </label>
                                <input type="date" 
                                       class="form-control" 
                                       id="data_nascimento" 
                                       name="data_nascimento"
                                       max="{{ date.today().strftime('%Y-%m-%d') }}">
                            </div>
                            <div class="col-md-6">
                                <label for="altura" class="form-label fw-semibold mb-2">
                                    <i class="fas fa-ruler-vertical me-1"></i> Altura
                                    <span class="optional-badge">Opcional</span>
                                </label>
                                <div class="input-group">
                                    <input type="text" 
                                           class="form-control" 
                                           id="altura" 
                                           name="altura" 
                                           placeholder="ex: 1.85"
                                           maxlength="5">
                                    <span class="input-group-text">m</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Telefone -->
                        <div class="mb-4">
                            <label for="telefone" class="form-label fw-semibold mb-2">
                                <i class="fas fa-phone me-1"></i> Telefone
                                <span class="optional-badge">Opcional</span>
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-phone"></i>
                                </span>
                                <input type="tel" 
                                       class="form-control with-icon" 
                                       id="telefone" 
                                       name="telefone" 
                                       placeholder="(11) 99999-9999"
                                       autocomplete="tel">
                            </div>
                            <div class="requirements mt-2">
                                <small>• Para contato em caso de dúvidas ou alterações</small>
                            </div>
                        </div>
                        
                        <!-- Cidade -->
                        <div class="mb-4">
                            <label for="cidade" class="form-label fw-semibold mb-2">
                                <i class="fas fa-city me-1"></i> Cidade
                                <span class="optional-badge">Opcional</span>
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-map-marker-alt"></i>
                                </span>
                                <input type="text" 
                                       class="form-control with-icon" 
                                       id="cidade" 
                                       name="cidade" 
                                       placeholder="Sua cidade"
                                       autocomplete="address-level2">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Seção: Informações Esportivas -->
                    <div class="form-section">
                        <h5 class="section-title">
                            <i class="fas fa-volleyball-ball"></i> Informações Esportivas
                        </h5>
                        
                        <!-- Linha com Posição e Nível -->
                        <div class="row mb-4">
                            <div class="col-md-6 mb-3 mb-md-0">
                                <label for="posicao" class="form-label fw-semibold mb-2">
                                    <i class="fas fa-volleyball-ball me-1"></i> Posição Preferida
                                    <span class="optional-badge">Opcional</span>
                                </label>
                                <select class="form-select" id="posicao" name="posicao">
                                    <option value="">Selecione uma posição</option>
                                    <option value="levantador">Levantador</option>
                                    <option value="ponteiro">Ponteiro</option>
                                    <option value="central">Central</option>
                                    <option value="oposto">Oposto</option>
                                    <option value="libero">Líbero</option>
                                    <option value="nao_informado">Não informado</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="nivel" class="form-label fw-semibold mb-2">
                                    <i class="fas fa-chart-line me-1"></i> Nível
                                    <span class="optional-badge">Opcional</span>
                                </label>
                                <select class="form-select" id="nivel" name="nivel">
                                    <option value="intermediario">Intermediário</option>
                                    <option value="iniciante">Iniciante</option>
                                    <option value="avancado">Avançado</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Nota sobre mensalidade -->
                    <div class="alert alert-info mb-4" role="alert">
                        <div class="d-flex">
                            <i class="fas fa-info-circle me-3 mt-1"></i>
                            <div>
                                <small>
                                    <strong>Importante:</strong> Para se tornar mensalista ou capitão, entre em contato com o administrador do sistema após completar seu perfil.
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Botões de ação -->
                    <div class="row g-3">
                        <div class="col-md-6">
                            <button type="submit" class="btn btn-complete-profile text-white py-3">
                                <i class="fas fa-check-circle me-2"></i> Completar Perfil
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button type="button" class="btn btn-skip py-3" id="skipBtn">
                                <i class="fas fa-forward me-2"></i> Completar Depois
                            </button>
                        </div>
                    </div>
                    
                    <!-- Nota sobre campos opcionais -->
                    <div class="text-center mt-4">
                        <p class="text-muted mb-0">
                            <small>
                                <i class="fas fa-info-circle me-1"></i>
                                Campos marcados como "Opcional" podem ser preenchidos posteriormente em seu perfil.
                            </small>
                        </p>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Container para alertas dinâmicos -->
<div class="alert-container"></div>

<!-- Debug info (opcional, remova em produção) -->
<div class="debug-info" id="debugInfo"></div>
{% endblock %}

{% block extra_js %}
<script>
// ======================================================
// FUNÇÕES DE COMPRESSÃO DE IMAGEM
// ======================================================

/**
 * Comprime uma imagem usando Canvas
 * @param {File} file - Arquivo de imagem original
 * @param {number} maxWidth - Largura máxima (px)
 * @param {number} maxHeight - Altura máxima (px)
 * @param {number} quality - Qualidade (0.1 a 1.0)
 * @param {number} maxSizeMB - Tamanho máximo em MB
 * @returns {Promise<File>} - Arquivo comprimido
 */
function compressImage(file, maxWidth = 1200, maxHeight = 1200, quality = 0.8, maxSizeMB = 4) {
    return new Promise((resolve, reject) => {
        const maxSizeBytes = maxSizeMB * 1024 * 1024;
        
        // Se a imagem já estiver abaixo do limite, não comprimir
        if (file.size <= maxSizeBytes) {
            resolve(file);
            return;
        }
        
        const img = new Image();
        const reader = new FileReader();
        
        reader.onload = function(e) {
            img.onload = function() {
                // Calcular novas dimensões mantendo proporção
                let width = img.width;
                let height = img.height;
                
                // Redimensionar apenas se necessário
                if (width > maxWidth || height > maxHeight) {
                    const ratio = Math.min(maxWidth / width, maxHeight / height);
                    width = Math.floor(width * ratio);
                    height = Math.floor(height * ratio);
                }
                
                // Criar canvas
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                
                const ctx = canvas.getContext('2d');
                
                // Configurar qualidade de renderização
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                
                // Desenhar imagem redimensionada
                ctx.drawImage(img, 0, 0, width, height);
                
                // Determinar formato de saída
                const outputType = file.type === 'image/png' ? 'image/png' : 'image/jpeg';
                
                // Função recursiva para tentar diferentes qualidades
                const tryCompression = (currentQuality, attempts = 1) => {
                    return new Promise((resolveCompress, rejectCompress) => {
                        canvas.toBlob(
                            (blob) => {
                                if (!blob) {
                                    rejectCompress(new Error('Falha na criação do blob'));
                                    return;
                                }
                                
                                // Verificar se está dentro do limite ou se atingiu tentativas máximas
                                if (blob.size <= maxSizeBytes || currentQuality <= 0.3 || attempts >= 4) {
                                    resolveCompress(blob);
                                } else {
                                    // Reduzir qualidade e tentar novamente
                                    setTimeout(() => {
                                        tryCompression(currentQuality * 0.7, attempts + 1)
                                            .then(resolveCompress)
                                            .catch(rejectCompress);
                                    }, 50);
                                }
                            },
                            outputType,
                            currentQuality
                        );
                    });
                };
                
                // Iniciar compressão
                tryCompression(quality)
                    .then((blob) => {
                        // Criar novo arquivo
                        const compressedFile = new File(
                            [blob],
                            file.name.replace(/\.[^/.]+$/, "") + '_compressed.jpg',
                            {
                                type: outputType,
                                lastModified: Date.now()
                            }
                        );
                        
                        resolve(compressedFile);
                    })
                    .catch((error) => {
                        console.error('Erro na compressão:', error);
                        reject(error);
                    });
            };
            
            img.onerror = function() {
                reject(new Error('Erro ao carregar imagem para compressão'));
            };
            
            img.src = e.target.result;
        };
        
        reader.onerror = function() {
            reject(new Error('Erro ao ler arquivo para compressão'));
        };
        
        reader.readAsDataURL(file);
    });
}

/**
 * Compressão automática com configurações padrão
 */
function compressImageAuto(file) {
    return compressImage(file, 1200, 1200, 0.8, 4);
}

// ======================================================
// FUNÇÕES AUXILIARES
// ======================================================

// Função para mostrar alertas
function showAlert(message, type = 'info') {
    const alertContainer = document.querySelector('.alert-container');
    
    // Criar alerta
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show mb-3`;
    alertDiv.innerHTML = `
        <i class="fas fa-${type === 'danger' ? 'exclamation-triangle' : 
                         type === 'warning' ? 'exclamation-circle' : 
                         type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Adicionar ao container
    alertContainer.appendChild(alertDiv);
    
    // Remover após 5 segundos
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Formatar tamanho de arquivo
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// ======================================================
// GERENCIAMENTO DE FOTO DE PERFIL
// ======================================================

document.addEventListener('DOMContentLoaded', function() {
    const fotoInput = document.getElementById('foto_input');
    const photoPreview = document.getElementById('photoPreview');
    const photoPlaceholder = document.getElementById('photoPlaceholder');
    const photoLoading = document.getElementById('photoLoading');
    const uploadPhotoBtn = document.getElementById('uploadPhotoBtn');
    const removePhotoBtn = document.getElementById('removePhotoBtn');
    const photoUploadArea = document.getElementById('photoUploadArea');
    const profileForm = document.getElementById('profileForm');
    const skipBtn = document.getElementById('skipBtn');
    const uploadProgress = document.getElementById('uploadProgress');
    const uploadProgressBar = document.getElementById('uploadProgressBar');
    const compressionInfo = document.getElementById('compressionInfo');
    const compressionStats = document.getElementById('compressionStats');
    const debugInfo = document.getElementById('debugInfo');
    
    // DEBUG: Mostrar info de debug (remova em produção)
    function updateDebugInfo(text) {
        if (debugInfo) {
            debugInfo.textContent = text;
            debugInfo.style.display = 'block';
            setTimeout(() => {
                debugInfo.style.display = 'none';
            }, 3000);
        }
    }
    
    // Abrir seletor de arquivo
    uploadPhotoBtn.addEventListener('click', () => fotoInput.click());
    photoUploadArea.addEventListener('click', (e) => {
        if (e.target !== removePhotoBtn && 
            !removePhotoBtn.contains(e.target) && 
            e.target !== uploadPhotoBtn && 
            !uploadPhotoBtn.contains(e.target)) {
            fotoInput.click();
        }
    });
    
    // Remover foto
    removePhotoBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        resetPhotoInput();
    });
    
    // Resetar input de foto
    function resetPhotoInput() {
        fotoInput.value = '';
        photoPreview.style.display = 'none';
        photoPlaceholder.style.display = 'flex';
        removePhotoBtn.style.display = 'none';
        uploadProgress.style.display = 'none';
        uploadProgressBar.style.width = '0%';
        compressionInfo.style.display = 'none';
    }
    
    // Preview da foto COM COMPRESSÃO
    fotoInput.addEventListener('change', async function() {
        const file = this.files[0];
        
        if (!file) {
            return;
        }
        
        // Mostrar loading
        photoLoading.style.display = 'flex';
        uploadProgress.style.display = 'block';
        uploadProgressBar.style.width = '10%';
        
        // Validar tipo de arquivo
        const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
        if (!validTypes.includes(file.type.toLowerCase())) {
            showAlert('Formato de imagem não suportado. Use JPG, PNG, GIF ou WebP.', 'danger');
            resetPhotoInput();
            return;
        }
        
        // Validar tamanho inicial (máx 20MB para compressão)
        const maxInitialSize = 20 * 1024 * 1024;
        if (file.size > maxInitialSize) {
            showAlert(`Imagem muito grande (${formatFileSize(file.size)}). Máximo: 20MB.`, 'danger');
            resetPhotoInput();
            return;
        }
        
        // Atualizar progresso
        uploadProgressBar.style.width = '30%';
        
        try {
            let finalFile = file;
            const originalSize = file.size;
            let wasCompressed = false;
            let compressionMessage = '';
            
            // DEBUG
            updateDebugInfo(`Processando: ${file.name} (${formatFileSize(originalSize)})`);
            
            // Se maior que 4MB, comprimir automaticamente
            if (originalSize > 4 * 1024 * 1024) {
                uploadProgressBar.style.width = '50%';
                
                // Mostrar info de compressão
                compressionInfo.style.display = 'block';
                compressionStats.innerHTML = `
                    <i class="fas fa-sync-alt fa-spin"></i> Comprimindo imagem...
                `;
                
                // Comprimir imagem
                finalFile = await compressImageAuto(file);
                wasCompressed = true;
                
                // Atualizar stats
                const compressedSize = finalFile.size;
                const reduction = ((originalSize - compressedSize) / originalSize * 100).toFixed(1);
                compressionMessage = `Redução: ${reduction}%`;
                
                compressionStats.innerHTML = `
                    <i class="fas fa-check-circle text-success"></i> 
                    ${formatFileSize(originalSize)} → ${formatFileSize(compressedSize)} (${reduction}% menor)
                `;
                
                showAlert(`Imagem comprimida: ${formatFileSize(originalSize)} → ${formatFileSize(compressedSize)}`, 'success');
            } else {
                // Esconder info de compressão se não foi necessária
                compressionInfo.style.display = 'none';
            }
            
            // Atualizar progresso
            uploadProgressBar.style.width = '80%';
            
            // Criar preview da imagem (comprimida ou original)
            const reader = new FileReader();
            
            reader.onload = function(e) {
                // Finalizar progresso
                uploadProgressBar.style.width = '100%';
                
                // Ocultar loading após delay
                setTimeout(() => {
                    photoLoading.style.display = 'none';
                    
                    // Atualizar preview
                    photoPreview.src = e.target.result;
                    photoPreview.style.display = 'block';
                    photoPlaceholder.style.display = 'none';
                    removePhotoBtn.style.display = 'flex';
                    
                    // Resetar barra de progresso após um tempo
                    setTimeout(() => {
                        uploadProgress.style.display = 'none';
                        uploadProgressBar.style.width = '0%';
                    }, 500);
                    
                    // DEBUG: Verificar se o arquivo está no input
                    updateDebugInfo(`Pronto: ${finalFile.name} (${formatFileSize(finalFile.size)})`);
                    
                }, 300);
            };
            
            reader.onerror = function() {
                showAlert('Erro ao processar imagem para preview.', 'danger');
                resetPhotoInput();
            };
            
            // IMPORTANTE: Substituir o arquivo no input pelo arquivo processado
            // Isso garante que o formulário envie o arquivo comprimido
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(finalFile);
            
            // DEBUG: Verificar antes da substituição
            updateDebugInfo(`Substituindo input: ${fotoInput.files.length} arquivo(s)`);
            
            // Substituir os arquivos no input
            fotoInput.files = dataTransfer.files;
            
            // DEBUG: Verificar após substituição
            updateDebugInfo(`Input atualizado: ${fotoInput.files.length} arquivo(s), ${formatFileSize(fotoInput.files[0]?.size || 0)}`);
            
            // Ler para preview
            reader.readAsDataURL(finalFile);
            
        } catch (error) {
            console.error('Erro no processamento da imagem:', error);
            showAlert('Erro ao processar imagem. Tente novamente com uma imagem menor.', 'danger');
            resetPhotoInput();
        }
    });
    
    // Drag and drop
    photoUploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.stopPropagation();
        this.classList.add('dragover');
    });
    
    photoUploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        e.stopPropagation();
        this.classList.remove('dragover');
    });
    
    photoUploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
        this.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            const file = files[0];
            
            // Verificar se é imagem
            if (!file.type.startsWith('image/')) {
                showAlert('Por favor, arraste apenas imagens.', 'warning');
                return;
            }
            
            // Atribuir arquivo ao input
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            fotoInput.files = dataTransfer.files;
            
            // Disparar evento change
            fotoInput.dispatchEvent(new Event('change', { bubbles: true }));
        }
    });
    
    // ======================================================
    // VALIDAÇÃO DO FORMULÁRIO
    // ======================================================
    
    // Formatação de telefone
    const telefoneInput = document.getElementById('telefone');
    if (telefoneInput) {
        telefoneInput.addEventListener('input', function() {
            let value = this.value.replace(/\D/g, '');
            
            if (value.length > 0) {
                if (value.length <= 10) {
                    value = value.replace(/^(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3');
                } else {
                    value = value.replace(/^(\d{2})(\d{5})(\d{0,4})/, '($1) $2-$3');
                }
            }
            
            this.value = value;
        });
    }
    
    // Formatação de altura
    const alturaInput = document.getElementById('altura');
    if (alturaInput) {
        alturaInput.addEventListener('input', function() {
            let value = this.value.replace(/[^\d.,]/g, '');
            value = value.replace(/,/g, '.');
            
            // Permitir apenas um ponto decimal
            const parts = value.split('.');
            if (parts.length > 2) {
                value = parts[0] + '.' + parts.slice(1).join('');
            }
            
            // Limitar a 2 casas decimais
            if (parts.length === 2 && parts[1].length > 2) {
                value = parts[0] + '.' + parts[1].substring(0, 2);
            }
            
            // Validar altura realista
            if (value && (parseFloat(value) < 1.0 || parseFloat(value) > 2.5)) {
                showAlert('Por favor, informe uma altura entre 1.0m e 2.5m.', 'warning');
                this.value = '';
                return;
            }
            
            this.value = value;
        });
    }
    
    // Validação do formulário
    profileForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Validar nome (campo obrigatório)
        const nomeInput = document.getElementById('nome');
        if (!nomeInput.value.trim()) {
            showAlert('Por favor, informe seu nome completo.', 'warning');
            nomeInput.focus();
            return;
        }
        
        // Validar altura se informada
        if (alturaInput && alturaInput.value) {
            const alturaValue = parseFloat(alturaInput.value.replace(',', '.'));
            if (isNaN(alturaValue) || alturaValue < 1.0 || alturaValue > 2.5) {
                showAlert('Por favor, informe uma altura válida entre 1.0m e 2.5m.', 'warning');
                alturaInput.focus();
                return;
            }
        }
        
        // DEBUG: Verificar se há arquivo no input
        if (fotoInput.files.length > 0) {
            updateDebugInfo(`Enviando: ${fotoInput.files[0].name} (${formatFileSize(fotoInput.files[0].size)})`);
        } else {
            updateDebugInfo('Nenhuma imagem selecionada');
        }
        
        // Mostrar loading
        const submitBtn = profileForm.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Salvando perfil...';
        submitBtn.disabled = true;
        
        // Desabilitar botão de skip também
        if (skipBtn) {
            skipBtn.disabled = true;
            skipBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Aguarde...';
        }
        
        // Enviar formulário
        this.submit();
    });
    
    // Botão "Completar Depois"
    skipBtn.addEventListener('click', function() {
        const nomeInput = document.getElementById('nome');
        
        // Validar nome
        if (!nomeInput.value.trim()) {
            showAlert('Por favor, informe pelo menos seu nome para continuar.', 'warning');
            nomeInput.focus();
            return;
        }
        
        // Mostrar loading
        this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Continuando...';
        this.disabled = true;
        
        // Desabilitar botão de submit
        const submitBtn = profileForm.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Aguarde...';
        
        // Enviar formulário
        profileForm.submit();
    });
    
    // Auto-foco no campo nome
    const nomeInput = document.getElementById('nome');
    if (nomeInput) {
        setTimeout(() => {
            nomeInput.focus();
        }, 300);
    }
    
    // Configurar data de nascimento
    const dataNascimentoInput = document.getElementById('data_nascimento');
    if (dataNascimentoInput) {
        const hoje = new Date();
        const hojeFormatado = hoje.toISOString().split('T')[0];
        dataNascimentoInput.max = hojeFormatado;
        
        // Sugerir data padrão (25 anos atrás)
        const dataSugerida = new Date();
        dataSugerida.setFullYear(dataSugerida.getFullYear() - 25);
        dataNascimentoInput.value = dataSugerida.toISOString().split('T')[0];
    }
    
    // Validação de data de nascimento
    if (dataNascimentoInput) {
        dataNascimentoInput.addEventListener('change', function() {
            if (this.value) {
                const selectedDate = new Date(this.value);
                const hoje = new Date();
                
                if (selectedDate > hoje) {
                    showAlert('A data de nascimento não pode ser futura.', 'warning');
                    this.value = '';
                    return;
                }
                
                // Calcular idade
                const diffMs = hoje - selectedDate;
                const age = Math.floor(diffMs / (1000 * 60 * 60 * 24 * 365.25));
                
                if (age < 12) {
                    showAlert('Você precisa ter pelo menos 12 anos para se cadastrar.', 'warning');
                    this.value = '';
                } else if (age > 100) {
                    showAlert('Por favor, verifique a data de nascimento.', 'warning');
                    this.value = '';
                }
            }
        });
    }
});

// Função para calcular idade (opcional)
function calcularIdade(dataNascimento) {
    if (!dataNascimento) return null;
    
    const hoje = new Date();
    const nascimento = new Date(dataNascimento);
    let idade = hoje.getFullYear() - nascimento.getFullYear();
    
    const mes = hoje.getMonth();
    const dia = hoje.getDate();
    
    if (mes < nascimento.getMonth() || 
        (mes === nascimento.getMonth() && dia < nascimento.getDate())) {
        idade--;
    }
    
    return idade;
}
</script>
{% endblock %}